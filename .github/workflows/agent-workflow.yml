# name: Job Application Agent Pipeline

# on:
#   # Manual trigger with options
#   workflow_dispatch:
#     inputs:
#       config_path:
#         description: 'Path to config file'
#         required: false
#         type: string
#         default: 'config.json'
#       max_jobs:
#         description: 'Maximum jobs to apply to'
#         required: false
#         type: string
#         default: '10'
#       min_score:
#         description: 'Minimum match score (0-100)'
#         required: false
#         type: string
#         default: '60'
#       mode:
#         description: 'Run mode'
#         required: false
#         type: choice
#         default: 'agent'
#         options:
#           - agent
#           - legacy
#       dry_run:
#         description: 'Dry run (no submissions)'
#         required: false
#         type: boolean
#         default: true
  
#   # Scheduled run (daily at 9 AM UTC)
#  # schedule:
#   #  - cron: '0 9 * * *'
  
#   # Reusable workflow
#   workflow_call:
#     inputs:
#       config_path:
#         description: Path to config file
#         required: false
#         type: string
#         default: config.json
#       mode:
#         description: Run mode (agent or legacy)
#         required: false
#         type: string
#         default: agent

# permissions:
#   contents: read

# concurrency:
#   group: job-application-agent
#   cancel-in-progress: true

# jobs:
#   run-agent:
#     runs-on: ubuntu-latest
    
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'
#           cache: 'pip'
#           cache-dependency-path: 'requirements.txt'

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Install Chrome (for Selenium)
#         uses: browser-actions/setup-chrome@v1
#         with:
#           chrome-version: stable

#       - name: Run Job Application Agent (New Mode)
#         if: ${{ inputs.mode != 'legacy' || github.event_name == 'schedule' }}
#         env:
#           SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
#           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#           OPENAI_EMBED_MODEL: "text-embedding-3-small"
#         run: |
#           echo "ðŸ¤– Running Job Application Agent..."
#           echo "Configuration:"
#           echo "  Config: ${{ inputs.config_path || 'config.json' }}"
#           echo "  Max Jobs: ${{ inputs.max_jobs || '10' }}"
#           echo "  Min Score: ${{ inputs.min_score || '60' }}"
#           echo "  Dry Run: ${{ inputs.dry_run != false }}"
#           echo ""
          
#           python agent_cli.py \
#             --config "${{ inputs.config_path || 'config.json' }}" \
#             --max-jobs ${{ inputs.max_jobs || 10 }} \
#             --min-score ${{ inputs.min_score || 60 }} \
#             ${{ (inputs.dry_run != false) && '--dry-run' || '' }}

#       - name: Run Legacy Match Mode
#         if: ${{ inputs.mode == 'legacy' }}
#         env:
#           SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
#           OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
#           OPENAI_EMBED_MODEL: "text-embedding-3-small"
#         run: |
#           echo "ðŸ“Š Running legacy match mode..."
#           python match.py --config "${{ inputs.config_path || 'config.json' }}"

#       - name: List outputs
#         if: always()
#         run: |
#           echo "ðŸ“ Output directory contents:"
#           ls -lR output/ || echo "No output directory found"

#       - name: Upload agent results
#         uses: actions/upload-artifact@v4
#         with:
#           name: agent-results-${{ github.run_id }}-${{ github.run_attempt }}
#           path: |
#             output/agent_results.json
#             output/*/*.json
#           if-no-files-found: warn
#           retention-days: 30

#       - name: Upload generated resumes
#         uses: actions/upload-artifact@v4
#         with:
#           name: resumes-${{ github.run_id }}-${{ github.run_attempt }}
#           path: |
#             output/*/resume_*.txt
#             output/*/resume_*.docx
#             output/tailored_resumes/*.txt
#             output/tailored_resumes/*.docx
#           if-no-files-found: warn
#           retention-days: 30

#       - name: Upload cover letters
#         uses: actions/upload-artifact@v4
#         with:
#           name: cover-letters-${{ github.run_id }}-${{ github.run_attempt }}
#           path: |
#             output/*/cover_letter_*.txt
#             output/cover_letters/*.txt
#           if-no-files-found: warn
#           retention-days: 30

#       - name: Upload job matches
#         uses: actions/upload-artifact@v4
#         with:
#           name: job-matches-${{ github.run_id }}-${{ github.run_attempt }}
#           path: |
#             output/*.json
#             output/*.csv
#           if-no-files-found: warn
#           retention-days: 30

#       - name: Generate Summary
#         if: always()
#         run: |
#           echo "# ðŸš€ Job Application Agent Results" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
          
#           # Check if agent results exist
#           if [ -f "output/agent_results.json" ]; then
#             echo "## ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY
            
#             # Extract stats using Python
#             python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
#           import json
#           import os
          
#           if os.path.exists("output/agent_results.json"):
#               with open("output/agent_results.json") as f:
#                   results = json.load(f)
              
#               print(f"- **Jobs Discovered**: {results.get('jobs_discovered', 0)}")
#               print(f"- **Jobs Analyzed**: {results.get('jobs_analyzed', 0)}")
#               print(f"- **Jobs Above Threshold**: {results.get('jobs_above_threshold', 0)}")
#               print(f"- **Resumes Generated**: {results.get('resumes_generated', 0)}")
#               print(f"- **Cover Letters Generated**: {results.get('cover_letters_generated', 0)}")
#               print(f"- **Applications Submitted**: {results.get('applications_submitted', 0)}")
              
#               if results.get('failures', 0) > 0:
#                   print(f"- âš ï¸  **Failures**: {results['failures']}")
              
#               print(f"- â±ï¸  **Time Elapsed**: {results.get('elapsed_seconds', 0):.1f}s")
#               print("")
              
#               # Top applications
#               if 'applications' in results and results['applications']:
#                   print("## ðŸŽ¯ Top Matches")
#                   print("")
#                   print("| Company | Title | Score | Status |")
#                   print("|---------|-------|-------|--------|")
#                   for app in results['applications'][:10]:
#                       company = app.get('company', 'Unknown')
#                       title = app.get('title', 'Unknown')[:40]
#                       score = app.get('score', 0)
#                       status = app.get('status', 'unknown')
#                       print(f"| {company} | {title} | {score:.1f} | {status} |")
#           else:
#               print("No agent results found. Check logs for errors.")
#           EOF
          
#           else
#             echo "âš ï¸ No agent results file found" >> $GITHUB_STEP_SUMMARY
#             echo "" >> $GITHUB_STEP_SUMMARY
#             echo "Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
#           fi
          
#           # List generated files
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## ðŸ“ Generated Files" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
          
#           if [ -d "output" ]; then
#             echo "```" >> $GITHUB_STEP_SUMMARY
#             find output -type f -name "*.txt" -o -name "*.json" -o -name "*.docx" | head -20 >> $GITHUB_STEP_SUMMARY
#             echo "```" >> $GITHUB_STEP_SUMMARY
#           else
#             echo "No output directory found." >> $GITHUB_STEP_SUMMARY
#           fi

#       - name: Notify on failure
#         if: failure()
#         run: |
#           echo "âŒ Job Application Agent failed!" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "Check the logs above for error details." >> $GITHUB_STEP_SUMMARY

